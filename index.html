<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Preview</title>
</head>
<body>
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Preview</title>
</head>
<body>
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GlassKart — Blue Light Filter Glasses</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=" />
<style>
  :root{
    --accent:#0066cc;
    --muted:#666;
    --bg:#f6f7fb;
    --card:#fff;
    --danger:#d32f2f;
    --success:#178a3d;
    --glass:#cfe8ff;
    font-family: Inter, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:#111; -webkit-font-smoothing:antialiased;
  }
  header{
    background:linear-gradient(90deg,#fff 0,#f8fbff 100%);
    padding:14px 20px; display:flex; gap:12px; align-items:center; border-bottom:1px solid #e7eefc; position:sticky; top:0; z-index:50;
  }
  .logo {font-weight:700; color:var(--accent); font-size:20px}
  .search{flex:1}
  .search input{width:100%; padding:10px 12px; border-radius:8px; border:1px solid #e0e7ff}
  .iconbar{display:flex; gap:12px; align-items:center}
  .icon{background:#fff; padding:8px; border-radius:8px; box-shadow:0 1px 3px rgba(10,20,40,0.06); cursor:pointer}
  .container{max-width:1120px; margin:20px auto; padding:0 16px}
  .grid{display:grid; grid-template-columns: repeat(auto-fill,minmax(250px,1fr)); gap:18px}
  .card{background:var(--card); border-radius:12px; padding:14px; box-shadow:0 6px 18px rgba(10,20,40,0.04); display:flex; flex-direction:column; gap:10px}
  .thumb{height:160px; border-radius:10px; background:linear-gradient(135deg,var(--glass),#e9f4ff); display:flex; align-items:center; justify-content:center; font-weight:700; color:#0b3558; position: relative; overflow: hidden;}
  .thumb img {height: 100%; width: 100%; object-fit: cover; transition: transform 0.5s ease-in-out;}
  .title{font-size:16px; font-weight:600}
  .price{font-size:18px; font-weight:700; color:#0b3558}
  .muted{color:var(--muted); font-size:13px}
  .btn{padding:10px 12px; border-radius:8px; border:0; cursor:pointer}
  .btn-primary{background:var(--accent); color:#fff}
  .btn-ghost{background:transparent; border:1px solid #e0e7ff}
  .out{opacity:0.6; filter:grayscale(20%)}
  footer{padding:28px; text-align:center; color:var(--muted)}

  /* cart panel */
  .cart-btn{position:relative}
  .cart-count{position:absolute; right:6px; top:6px; background:#ff3b30; color:#fff; border-radius:12px; padding:2px 7px; font-size:12px}
  .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center; z-index:100}
  .modal{background:var(--card); border-radius:12px; box-shadow:0 10px 40px rgba(10,20,40,0.4); max-width:960px; width:100%; max-height:90vh; overflow:auto}
  .modal .head{display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid #f0f6ff}
  .modal .body{padding:18px}
  .cart-list{display:flex; flex-direction:column; gap:12px}
  .cart-item{display:flex; gap:12px; align-items:center; padding:10px; border-radius:8px; border:1px solid #f1f6ff}
  .cart-item img{width:70px; height:55px; object-fit:cover; border-radius:6px}
  .qtybox{display:flex; gap:6px; align-items:center}
  .small{font-size:13px}
  .summary{background:#fcfdff; padding:12px; border-radius:10px; border:1px solid #eef6ff}

  /* orders modal */
  .orders-list{display:flex; flex-direction:column; gap:12px}
  .order-card{border:1px solid #eef6ff; padding:12px; border-radius:8px; background:#fff}
  .danger-border { border-color: var(--danger) !important; }

  /* responsive */
  @media (max-width:640px){
    .thumb{height:120px}
    header{padding:10px}
    /* Mobile-specific adjustments */
    .modal .body > div {
      flex-direction: column;
    }
    .modal .body > div > div {
      width: 100% !important;
      min-width: unset;
    }
    .promo-suggestion{
      flex-wrap: wrap;
    }
    /* ADDED: Mobile-specific layout for promo/summary */
    #cartSummarySection {
      flex-direction: column;
      align-items: flex-start;
    }
    #cartSummarySection > div {
      width: 100%;
      margin-top: 12px;
    }
    #cartSummarySection .summary {
      width: 100%;
    }
  }

  /* promo box */
  .promo-suggestion{background:#e9f7ff; padding:8px 10px; border-radius:8px; display:inline-flex; gap:10px; align-items:center; margin-top:6px}
  .qr-wrap{display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:center}
  .upi-box{background:#fff; padding:10px; border-radius:8px; border:1px dashed #e9f1ff}
  .mutetxt{color:#8a98a9; font-size:13px}
  .remove-promo {
    background: #eef6ff;
    color: #666;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    cursor: pointer;
    font-size: 14px;
    margin-left: 8px; /* Added margin for spacing */
  }

  /* Image gallery/modal styles */
  .gallery-container {
    display: flex;
    width: 100%;
    height: 100%;
    transition: transform 0.5s ease-in-out;
  }
  .gallery-container img {
    min-width: 100%;
    max-width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .thumb-nav {
    position: absolute;
    top: 50%;
    width: 100%;
    display: flex;
    justify-content: space-between;
    transform: translateY(-50%);
    padding: 0 5px;
  }
  .thumb-nav button {
    background: rgba(0,0,0,0.3);
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .popup-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 101;
    cursor: zoom-out;
  }
  .popup-content {
    position: relative;
    max-width: 90%;
    max-height: 90%;
    overflow: hidden; /* Hide extra images */
  }
  .popup-image-container {
    display: flex;
    transition: transform 0.5s ease-in-out;
  }
  .popup-image-container img {
    max-width: 100%;
    min-width: 100%; /* Ensure images take full width of container */
    max-height: 90vh;
    object-fit: contain;
  }
  .popup-nav {
    position: absolute;
    top: 50%;
    width: 100%;
    display: flex;
    justify-content: space-between;
    transform: translateY(-50%);
    z-index: 102;
    padding: 0 10px;
  }
  .popup-nav button {
    background: rgba(255,255,255,0.3);
    border: none;
    color: black;
    font-size: 30px;
    cursor: pointer;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .popup-close {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(255,255,255,0.3);
    color: black;
    border: none;
    font-size: 24px;
    cursor: pointer;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
</style>
</head>
<body>
<header>
  <div class="logo">GlassKart</div>
  <div class="search"><input id="siteSearch" placeholder="Search blue light glasses, e.g. 'Classic Blue'"/></div>
  <div class="iconbar">
    <div class="icon" id="ordersBtn" title="My Orders (click)">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 6h18" stroke="#0b3558" stroke-width="1.6" stroke-linecap="round"/><path d="M3 12h18" stroke="#0b3558" stroke-width="1.6" stroke-linecap="round"/><path d="M3 18h18" stroke="#0b3558" stroke-width="1.6" stroke-linecap="round"/></svg>
    </div>
    <div class="icon cart-btn" id="cartBtn" title="Cart">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M6 6h15l-1.5 9h-11z" stroke="#0b3558" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><circle cx="10" cy="20" r="1" fill="#0b3558"/><circle cx="18" cy="20" r="1" fill="#0b3558"/></svg>
      <div class="cart-count" id="cartCount" style="display:none">0</div>
    </div>
  </div>
</header>

<main class="container">
  <section style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px">
    <div>
      <h1 style="margin:0; font-size:20px">Blue Light Filter Glasses — Comfortable, Stylish</h1>
      <div class="muted">Protect your eyes during long screen sessions</div>
    </div>
  </section>

  <section class="grid" id="productGrid">
    </section>
</main>

<div class="modal-backdrop" id="cartModal">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="head">
      <div style="display:flex; gap:12px; align-items:center">
        <h3 style="margin:0">Your Cart</h3>
        <div class="muted small" id="cartStatus">0 items</div>
      </div>
      <div>
        <button class="btn btn-ghost" id="closeCart">Close</button>
      </div>
    </div>

    <div class="body">
      <div style="display:flex; gap:18px; flex-wrap:wrap">
        <div style="flex:1; min-width:280px">
          <div class="cart-list" id="cartList">
            </div>

          <div id="cartSummarySection" style="margin-top:12px; display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
            <div>
              <label class="muted small">Promocode</label>
              <div style="display:flex; gap:8px; margin-top:6px">
                <input id="promoInput" placeholder="Enter code" style="padding:10px; border-radius:8px; border:1px solid #e7efff; flex:1" />
                <button class="btn btn-primary" id="applyPromo">Apply</button>
              </div>
              <div class="promo-suggestion" id="promoSuggest">
                <div style="font-weight:700">Use <span style="color:var(--accent)">CBSKARTV25</span></div>
                <div class="muted small">— Save ₹1,501 (expires in 3 days)</div>
              </div>
              <div style="margin-top:8px" id="promoMsg"></div>
            </div>

            <div style="width:320px">
              <div class="summary">
                <div style="display:flex; justify-content:space-between"><div class="muted small">Subtotal</div><div id="subtotalText">₹0</div></div>
                <div style="display:flex; justify-content:space-between"><div class="muted small">Discount</div><div id="discountText">- ₹0</div></div>
                <hr style="border:none; border-top:1px dashed #eef6ff; margin:8px 0" />
                <div style="display:flex; justify-content:space-between; font-weight:700"><div>Total</div><div id="totalText">₹0</div></div>
                <div style="margin-top:10px; display:flex; gap:8px; justify-content:space-between; align-items:center">
                  <button class="btn btn-primary" id="proceedBtn">Checkout</button>
                  <button class="btn btn-ghost" id="clearCart">Clear</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div style="width:360px; min-width:260px">
          <div class="card">
            <h4 style="margin:0 0 6px 0">Delivery details</h4>
            <div class="muted small">Please enter shipping details before payment</div>
            <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px">
              <input id="nameInput" placeholder="Full name" style="padding:10px; border-radius:8px; border:1px solid #eef6ff" />
              <input id="phoneInput" placeholder="Mobile number" style="padding:10px; border-radius:8px; border:1px solid #eef6ff" />
              <textarea id="addressInput" rows="3" placeholder="Full address" style="padding:10px; border-radius:8px; border:1px solid #eef6ff"></textarea>
              <input id="pincodeInput" placeholder="Pincode" style="padding:10px; border-radius:8px; border:1px solid #eef6ff" />
              <div id="deliveryEstimate" class="muted small" style="margin-top:6px; min-height:1rem"></div>
            </div>

            <hr style="margin:12px 0; border:none; border-top:1px solid #f4f8ff" />

            <div id="paymentSection" style="display:none;">
              <h4 style="margin:0 0 6px 0">Payment</h4>
              <div style="margin-top:8px" class="qr-wrap">
                <div style="padding:10px; background:#fff; border-radius:8px; text-align:center">
                  <div style="font-size:13px; margin-bottom:6px">Scan QR</div>
                  <img id="upiQR" alt="UPI QR" style="width:140px; height:140px; border-radius:8px; background:#fff" />
                </div>
              </div>
              <a id="openUpi" class="btn btn-primary" href="#" target="_blank" style="display:block; text-align:center; margin-top: 12px;">Proceed to Pay via UPI</a>
            </div>

            <div id="emptyCartMessage" style="color:var(--muted); text-align:center; display:none;">
              <h4 style="margin:0 0 6px 0">Payment</h4>
              <p>Please add product to cart first.</p>
            </div>

            <div style="margin-top:12px;">
              <div class="muted small" style="color:var(--danger)">After payment, you can submit your transaction id below</div>
              <div style="display:flex; gap:8px; margin-top:8px">
                <input id="txnInput" placeholder="Transaction ID (UPI Txn/Ref)" class="danger-border" style="padding:10px; border-radius:8px; flex:1" />
                <button class="btn btn-primary" id="submitTxn">Submit</button>
              </div>
              <div id="txnMsg" style="margin-top:8px"></div>
            </div>

          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<div class="popup-modal" id="imagePopupModal">
  <div class="popup-content">
    <div class="popup-image-container" id="popupImageContainer"></div>
    <div class="popup-nav">
      <button id="popupPrevBtn">‹</button>
      <button id="popupNextBtn">›</button>
    </div>
    <button class="popup-close" id="popupCloseBtn">×</button>
  </div>
</div>

<div class="modal-backdrop" id="ordersModal">
  <div class="modal" role="dialog" aria-modal="true" style="max-width:820px">
    <div class="head">
      <h3 style="margin:0">My Orders</h3>
      <div><button class="btn btn-ghost" id="closeOrders">Close</button></div>
    </div>
    <div class="body">
      <div class="orders-list" id="ordersList">
        </div>
      <div style="margin-top:12px; color:var(--muted); font-size:13px">Click an order to view/print/download as PDF.</div>
    </div>
  </div>
</div>

<footer>
  © 2025 — GlassKart
</footer>

<script>
/* ====== SETTINGS ======
 * Replace the FORMSPREE_URL with your formspree endpoint:
 * Example: const FORMSPREE_URL = 'https://formspree.io/f/mnqwpzln';
 */
const FORMSPREE_URL = 'https://formspree.io/f/yourformid'; // <-- REPLACE this with your Formspree form action URL

// site data
const PRODUCTS = (() => {
  const arr = [];
  // first product (in stock)
  arr.push({
    id: 'g1',
    name: 'Classic Blue Light Filter Glasses (Premium)',
    desc: 'Anti-glare lenses, lightweight frame, unisex.',
    price: 2299,
    inStock: true,
    img: [
      'https://raw.githubusercontent.com/xpreview/glasskart/refs/heads/main/WhatsApp%20Image%202025-09-21%20at%2017.45.57_274d9503.jpg',
      'https://raw.githubusercontent.com/xpreview/glasskart/refs/heads/main/WhatsApp%20Image%202025-09-21%20at%2017.45.57_95d0550a.jpg',
      'https://raw.githubusercontent.com/xpreview/glasskart/refs/heads/main/WhatsApp%20Image%202025-09-21%20at%2017.45.58_768881fb.jpg',
      'https://raw.githubusercontent.com/xpreview/glasskart/refs/heads/main/WhatsApp%20Image%202025-09-21%20at%2018.13.08_a3bf6a6d.jpg',
      'https://raw.githubusercontent.com/xpreview/glasskart/refs/heads/main/WhatsApp%20Image%202025-09-21%20at%2018.13.08_80f4e672.jpg'
    ]
  });
  // other 14 products out of stock
  for(let i=2;i<=15;i++){
    arr.push({
      id: 'g'+i,
      name: `Classic Blue Filter Glass Model ${i}`,
      desc: 'Currently unavailable.',
      price: 2299 + i*10,
      inStock: false,
      img: null
    });
  }
  return arr;
})();

// promo config (code + discount amount)
const PROMO_CODE = 'CBSKARTV25';
const PROMO_DISCOUNT = 1501;

// promo expiry: 3 days from today (displayed to user and enforced)
const promoExpiryDate = (() => {
  const d = new Date();
  d.setDate(d.getDate() + 3);
  // zero time for compare
  d.setHours(23,59,59,999);
  return d;
})();

// utility: format INR
function fmtINR(n){
  return '₹' + n.toLocaleString('en-IN', {maximumFractionDigits:0});
}

/* ---------- DOM helpers ---------- */
const productGrid = document.getElementById('productGrid');
const cartBtn = document.getElementById('cartBtn');
const cartCountEl = document.getElementById('cartCount');
const cartModal = document.getElementById('cartModal');
const cartListEl = document.getElementById('cartList');
const subtotalText = document.getElementById('subtotalText');
const totalText = document.getElementById('totalText');
const discountText = document.getElementById('discountText');
const cartStatus = document.getElementById('cartStatus');
const promoSuggest = document.getElementById('promoSuggest');
const promoExpiryText = document.getElementById('promoExpiryText');
const promoInput = document.getElementById('promoInput');
const applyPromoBtn = document.getElementById('applyPromo');
const promoMsg = document.getElementById('promoMsg');
const proceedBtn = document.getElementById('proceedBtn');
const closeCart = document.getElementById('closeCart');
const clearCartBtn = document.getElementById('clearCart');

const nameInput = document.getElementById('nameInput');
const phoneInput = document.getElementById('phoneInput');
const addressInput = document.getElementById('addressInput');
const pincodeInput = document.getElementById('pincodeInput');
const deliveryEstimate = document.getElementById('deliveryEstimate');

const upiQR = document.getElementById('upiQR');
const openUpiLink = document.getElementById('openUpi');
const txnInput = document.getElementById('txnInput');
const submitTxnBtn = document.getElementById('submitTxn');
const txnMsg = document.getElementById('txnMsg');
const paymentSection = document.getElementById('paymentSection');
const emptyCartMessage = document.getElementById('emptyCartMessage');

const ordersBtn = document.getElementById('ordersBtn');
const ordersModal = document.getElementById('ordersModal');
const ordersList = document.getElementById('ordersList');
const closeOrders = document.getElementById('closeOrders');

const imagePopupModal = document.getElementById('imagePopupModal');
const popupImageContainer = document.getElementById('popupImageContainer');
const popupPrevBtn = document.getElementById('popupPrevBtn');
const popupNextBtn = document.getElementById('popupNextBtn');
const popupCloseBtn = document.getElementById('popupCloseBtn');

const cartCountKey = 'gk_cart_v1';
const ordersKey = 'gk_orders_v1';
const txnsKey = 'gk_txns_v1';
const userDetailsKey = 'gk_userDetails_v1';

let cart = loadCart();
let appliedPromo = loadPromo(); // {code, appliedOn}
let currentImageIndex = 0;
let currentProductImages = [];

function loadCart(){
  try{
    const raw = localStorage.getItem(cartCountKey);
    return raw ? JSON.parse(raw) : [];
  }catch(e){ return [];}
}
function saveCart(){
  localStorage.setItem(cartCountKey, JSON.stringify(cart));
}
function loadPromo(){
  try{
    const raw = localStorage.getItem('gk_promo_v1');
    return raw ? JSON.parse(raw) : null;
  }catch(e){ return null; }
}
function savePromo(){
  localStorage.setItem('gk_promo_v1', JSON.stringify(appliedPromo));
}
function saveUserDetails() {
  const userDetails = {
    name: nameInput.value,
    phone: phoneInput.value,
    address: addressInput.value,
    pincode: pincodeInput.value
  };
  localStorage.setItem(userDetailsKey, JSON.stringify(userDetails));
}
function loadUserDetails() {
  try {
    const raw = localStorage.getItem(userDetailsKey);
    if (raw) {
      const userDetails = JSON.parse(raw);
      nameInput.value = userDetails.name || '';
      phoneInput.value = userDetails.phone || '';
      addressInput.value = userDetails.address || '';
      pincodeInput.value = userDetails.pincode || '';
      updateDeliveryEstimate();
    }
  } catch (e) {
    console.error('Failed to load user details from local storage', e);
  }
}

/* ---------- Render products ---------- */
function renderProducts(list=PRODUCTS){
  productGrid.innerHTML = '';
  for(const p of list){
    const el = document.createElement('div');
    el.className = 'card' + (p.inStock ? '' : ' out');
    
    let thumbContent;
    if (p.id === 'g1' && p.img && p.img.length > 0) {
      thumbContent = `
        <div class="gallery-container" id="gallery-${p.id}">
          ${p.img.map(imgSrc => `<img src="${imgSrc}" alt="${escapeHtml(p.name)}" />`).join('')}
        </div>
        <div class="thumb-nav">
          <button class="prev-thumb" data-id="${p.id}">‹</button>
          <button class="next-thumb" data-id="${p.id}">›</button>
        </div>
      `;
    } else {
      thumbContent = p.img ? `<img src="${p.img}" alt="${escapeHtml(p.name)}" />` : (p.inStock ? 'In stock' : 'Out of stock');
    }

    el.innerHTML = `
      <div class="thumb">${thumbContent}</div>
      <div style="display:flex; justify-content:space-between; align-items:center">
        <div>
          <div class="title">${escapeHtml(p.name)}</div>
          <div class="muted small">${escapeHtml(p.desc)}</div>
        </div>
        <div style="text-align:right">
          <div class="price">${fmtINR(p.price)}</div>
          <div class="muted small">Inclusive of taxes</div>
        </div>
      </div>
      <div style="display:flex; gap:8px; margin-top:8px">
        <button class="btn btn-primary addToCart" data-id="${p.id}" ${p.inStock ? '' : 'disabled'}>${p.inStock ? 'Add to cart' : 'Notify me'}</button>
        <button class="btn btn-ghost viewProductBtn" data-id="${p.id}" ${p.id !== 'g1' ? 'disabled' : ''}>View</button>
      </div>
    `;
    productGrid.appendChild(el);
  }
}

/* ---------- Image Gallery & Popup Logic ---------- */
function updateThumbGallery(id, index) {
  const gallery = document.getElementById(`gallery-${id}`);
  if (!gallery) return;
  const imageWidth = gallery.children[0].offsetWidth;
  gallery.style.transform = `translateX(-${index * imageWidth}px)`;
}

function showPopup(id) {
  const product = findProduct(id);
  if (!product || !product.img || !Array.isArray(product.img) || product.img.length === 0) {
    alert('No images to display.');
    return;
  }
  currentProductImages = product.img;
  currentImageIndex = 0;
  popupImageContainer.innerHTML = '';
  currentProductImages.forEach(imgSrc => {
    const img = document.createElement('img');
    img.src = imgSrc;
    img.alt = product.name;
    popupImageContainer.appendChild(img);
  });
  updatePopupImage(currentImageIndex);
  imagePopupModal.style.display = 'flex';
}

function updatePopupImage(index) {
  const container = document.getElementById('popupImageContainer');
  const imageWidth = container.children[0].offsetWidth;
  container.style.transform = `translateX(-${index * imageWidth}px)`;
  popupPrevBtn.disabled = index === 0;
  popupNextBtn.disabled = index === currentProductImages.length - 1;
}

popupPrevBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  if (currentImageIndex > 0) {
    currentImageIndex--;
    updatePopupImage(currentImageIndex);
  }
});

popupNextBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  if (currentImageIndex < currentProductImages.length - 1) {
    currentImageIndex++;
    updatePopupImage(currentImageIndex);
  }
});

popupCloseBtn.addEventListener('click', () => {
  imagePopupModal.style.display = 'none';
});

imagePopupModal.addEventListener('click', (e) => {
  if (e.target.id === 'imagePopupModal') {
    imagePopupModal.style.display = 'none';
  }
});

/* ---------- Cart logic ---------- */
function findProduct(id){ return PRODUCTS.find(x=>x.id===id); }
function addToCart(id, qty=1){
  const p = findProduct(id);
  if(!p || !p.inStock) return;
  const item = cart.find(c=>c.id===id);
  if(item) item.qty += qty;
  else cart.push({id:id, qty:qty, price:p.price, name:p.name, img:p.img});
  saveCart();
  renderCart();
  showCart();
}
function removeFromCart(id){
  cart = cart.filter(c=>c.id!==id);
  saveCart();
  renderCart();
}
function updateQty(id, qty){
  const it = cart.find(c=>c.id===id);
  if(!it) return;
  it.qty = Math.max(1, qty|0);
  saveCart();
  renderCart();
}
function clearCart(){
  cart = [];
  saveCart();
  appliedPromo = null;
  savePromo();
  renderCart();
}

function calcTotals(){
  const subtotal = cart.reduce((s,c)=> s + (c.price * c.qty), 0);
  let discount = 0;
  if(appliedPromo && appliedPromo.code === PROMO_CODE){
    // ensure promo not expired
    const now = new Date();
    if(now <= promoExpiryDate){
      discount = Math.min(PROMO_DISCOUNT, subtotal);
    }else{
      // expired, clear
      appliedPromo = null;
      savePromo();
    }
  }
  const total = Math.max(0, subtotal - discount);
  return {subtotal, discount, total};
}

function renderCart(){
  // update UI
  const count = cart.reduce((s,c)=>s+c.qty, 0);
  if(count>0){ cartCountEl.style.display='block'; cartCountEl.textContent = count; }
  else cartCountEl.style.display='none';
  cartListEl.innerHTML = '';
  if(cart.length===0){
    cartListEl.innerHTML = '<div class="muted">Your cart is empty. Add items to proceed.</div>';
    paymentSection.style.display = 'none';
    emptyCartMessage.style.display = 'block';
  }else{
    for(const it of cart){
      const row = document.createElement('div');
      row.className = 'cart-item';
      const p = findProduct(it.id);
      const imgSource = (Array.isArray(p.img) && p.img.length > 0) ? p.img[0] : (p.img ? p.img : `data:image/svg+xml;utf8,${encodeURIComponent(generatePlaceholderSVG(p.name))}`);
      row.innerHTML = `
        <img src="${imgSource}" alt="${escapeHtml(p.name)}" />
        <div style="flex:1">
          <div style="font-weight:700">${escapeHtml(it.name)}</div>
          <div class="muted small">Price: ${fmtINR(it.price)}</div>
          <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
            <div class="qtybox small">
              <button class="btn-ghost small decBtn" data-id="${it.id}">-</button>
              <div style="padding:6px 8px; border-radius:6px; border:1px solid #eef6ff">${it.qty}</div>
              <button class="btn-ghost small incBtn" data-id="${it.id}">+</button>
            </div>
            <div class="muted small">Total: <strong>${fmtINR(it.price*it.qty)}</strong></div>
          </div>
        </div>
        <div style="text-align:right">
          <button class="btn btn-ghost removeBtn" data-id="${it.id}">Remove</button>
        </div>
      `;
      cartListEl.appendChild(row);
    }
    paymentSection.style.display = 'block';
    emptyCartMessage.style.display = 'none';
  }
  const totals = calcTotals();
  subtotalText.textContent = fmtINR(totals.subtotal);
  discountText.textContent = '- ' + fmtINR(totals.discount);
  totalText.textContent = fmtINR(totals.total);
  cartStatus.textContent = `${cart.length} ${cart.length===1?'item':'items'}`;
  setUpiDisplay();
}

/* ---------- promo ---------- */
function isPromoExpired(){
  return new Date() > promoExpiryDate;
}
function showPromoExpiry(){
  const opt = { year: 'numeric', month: 'short', day: 'numeric' };
  promoExpiryText.textContent = `Expires: ${promoExpiryDate.toLocaleDateString(undefined,opt)}`;
  // also in suggestion small text:
  promoSuggest.querySelector('.muted')?.textContent;
}

function removePromo(){
  appliedPromo = null;
  savePromo();
  promoInput.value = '';
  promoMsg.innerHTML = '';
  renderCart();
}

applyPromoBtn.addEventListener('click', ()=>{
  const code = (promoInput.value || '').trim();
  if(!code){
    // CHANGED: Added logic to remove discount on empty code
    appliedPromo = null;
    savePromo();
    promoMsg.innerHTML = '<span style="color:var(--danger)">Enter a promocode</span>';
    renderCart();
    return;
  }
  if(isPromoExpired()){
    appliedPromo = null;
    savePromo();
    promoMsg.innerHTML = '<span style="color:var(--danger)">This promocode has expired.</span>';
    renderCart();
    return;
  }
  if(code === PROMO_CODE){
    appliedPromo = { code: code, appliedOn: new Date().toISOString() };
    savePromo();
    promoMsg.innerHTML = `<span style="color:var(--success)">Applied ${code} — ₹${PROMO_DISCOUNT} off</span> <span class="remove-promo">×</span>`;
    const removeBtn = promoMsg.querySelector('.remove-promo');
    if (removeBtn) {
      removeBtn.addEventListener('click', removePromo);
    }
    renderCart();
  }else{
    // CHANGED: Added logic to clear promo for invalid codes
    appliedPromo = null;
    savePromo();
    promoMsg.innerHTML = '<span style="color:var(--danger)">Invalid promocode</span>';
    renderCart();
  }
});

/* ---------- Checkout / Delivery estimate ---------- */
pincodeInput.addEventListener('input', updateDeliveryEstimate);
function updateDeliveryEstimate(){
  const pin = (pincodeInput.value||'').trim();
  if(!/^\d{6}$/.test(pin)){
    deliveryEstimate.textContent = '';
    return;
  }
  // delivery date = current date + 10 days
  const d = new Date();
  d.setDate(d.getDate() + 10);
  const opt = { year:'numeric', month:'short', day:'numeric' };
  deliveryEstimate.innerHTML = `Delivery by <strong>${d.toLocaleDateString(undefined,opt)}</strong>`;
}

/* ---------- Payment: UPI link + QR ---------- */
const upiId = 'oksdcb@ybl';
function buildUpiLink(amount){
  // amount optional
  const pa = encodeURIComponent(upiId);
  const pn = encodeURIComponent('GlassKart');
  const mc = encodeURIComponent('GlassKart');
  let link = `upi://pay?pa=${pa}&pn=${pn}&mc=${mc}`;
  if(amount) link += `&am=${amount}`;
  link += `&cu=INR`;
  return link;
}
function setUpiDisplay(){
  const totals = calcTotals();
  const upi = buildUpiLink(totals.total > 0 ? totals.total : '');
  openUpiLink.href = upi;
  // generate QR via new API
  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(upi)}`;
  upiQR.src = qrUrl;
  console.log('QR Code URL:', qrUrl);
}

/* ---------- Submit transaction id / Formspree ---------- */
submitTxnBtn.addEventListener('click', async ()=>{
  const txn = (txnInput.value||'').trim();
  const name = (nameInput.value||'').trim();
  const phone = (phoneInput.value||'').trim();
  const addr = (addressInput.value||'').trim();
  const pin = (pincodeInput.value||'').trim();
  
  const submittedTxns = JSON.parse(localStorage.getItem(txnsKey) || '[]');
  if (submittedTxns.includes(txn)) {
    txnMsg.innerHTML = '<span style="color:var(--danger)">Transaction ID already submitted.</span>';
    return;
  }

  if(!txn || !name || !phone || !addr || cart.length===0){
    txnMsg.innerHTML = '<span style="color:var(--danger)">Please add products to cart and complete all details (name, phone, address) before submitting.</span>';
    return;
  }

  // Save user details to local storage
  saveUserDetails();

  // build data payload
  const order = {
    id: 'ORD-'+Date.now(),
    name, phone, address: `${addr}, Pincode: ${pin}`, txnId: txn,
    items: cart.map(c=>({id:c.id, name:c.name, qty:c.qty, price:c.price})),
    subtotal: calcTotals().subtotal,
    discount: calcTotals().discount,
    total: calcTotals().total,
    date: new Date().toISOString()
  };

  txnMsg.textContent = 'Submitting...';
  // send to Formspree
  try{
    if(!FORMSPREE_URL || FORMSPREE_URL.includes('yourformid')){
      // placeholder: still save order locally and show success, but warn user
      txnMsg.innerHTML = '<span style="color:var(--muted)">Formspree endpoint not configured. Replace FORMSPREE_URL in the HTML with your endpoint to send data. Order saved locally.</span>';
      saveOrder(order);
      submittedTxns.push(txn);
      localStorage.setItem(txnsKey, JSON.stringify(submittedTxns));
      clearCart();
      renderOrders();
      txnMsg.innerHTML = `<span style="color:var(--success)">✔ Transaction ID submitted!</span>`;
      return;
    }
    const formData = new FormData();
    formData.append('orderId', order.id);
    formData.append('name', order.name);
    formData.append('phone', order.phone);
    formData.append('address', order.address);
    formData.append('pincode', order.pincode);
    formData.append('txnId', order.txnId);
    formData.append('items', JSON.stringify(order.items));
    formData.append('subtotal', order.subtotal);
    formData.append('discount', order.discount);
    formData.append('total', order.total);
    formData.append('date', order.date);

    const res = await fetch(FORMSPREE_URL, { method:'POST', body: formData, headers: { 'Accept': 'application/json' } });
    if(res.ok){
      txnMsg.innerHTML = `<span style="color:var(--success)">✔ Transaction ID submitted!</span>`;
      saveOrder(order);
      submittedTxns.push(txn);
      localStorage.setItem(txnsKey, JSON.stringify(submittedTxns));
      clearCart();
      renderOrders();
    }else{
      const text = await res.text();
      txnMsg.innerHTML = `<span style="color:var(--danger)">Submission failed. Server response: ${escapeHtml(text)}</span>`;
    }
  }catch(err){
    txnMsg.innerHTML = `<span style="color:var(--danger)">Error sending: ${escapeHtml(err.message)}</span>`;
  }
});

function saveOrder(order){
  try{
    const raw = localStorage.getItem(ordersKey);
    const arr = raw ? JSON.parse(raw) : [];
    arr.unshift(order); // latest first
    localStorage.setItem(ordersKey, JSON.stringify(arr));
  }catch(e){}
}

/* ---------- Orders modal ---------- */
ordersBtn.addEventListener('click', ()=>{
  renderOrders();
  ordersModal.style.display = 'flex';
});
closeOrders.addEventListener('click', ()=> ordersModal.style.display='none');

function renderOrders(){
  ordersList.innerHTML = '';
  const raw = localStorage.getItem(ordersKey);
  const arr = raw ? JSON.parse(raw) : [];
  if(arr.length===0){
    ordersList.innerHTML = '<div class="muted">No orders yet.</div>';
    return;
  }
  for(const o of arr){
    const card = document.createElement('div');
    card.className = 'order-card';
    const date = new Date(o.date).toLocaleString();
    card.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div style="font-weight:700">Order ${escapeHtml(o.id)}</div>
          <div class="muted small">${escapeHtml(o.name)} • ${escapeHtml(o.phone)} • ${escapeHtml(date)}</div>
        </div>
        <div style="display:flex; gap:8px">
          <button class="btn btn-ghost viewOrderBtn" data-id="${escapeHtml(o.id)}">View</button>
          <button class="btn btn-primary printOrderBtn" data-id="${escapeHtml(o.id)}">Download PDF</button>
        </div>
      </div>
    `;
    ordersList.appendChild(card);
  }

  // attach listeners
  document.querySelectorAll('.viewOrderBtn').forEach(btn=>{
    btn.addEventListener('click', ()=> {
      const id = btn.dataset.id;
      const raw = localStorage.getItem(ordersKey);
      const arr = raw ? JSON.parse(raw) : [];
      const o = arr.find(x=>x.id===id);
      if(!o) return alert('Order not found');
      alert(prettyOrderText(o));
    });
  });
  document.querySelectorAll('.printOrderBtn').forEach(btn=>{
    btn.addEventListener('click', ()=> {
      const id = btn.dataset.id;
      const raw = localStorage.getItem(ordersKey);
      const arr = raw ? JSON.parse(raw) : [];
      const o = arr.find(x=>x.id===id);
      if(!o) return alert('Order not found');
      // open printable window
      const w = window.open('', '_blank');
      const html = renderOrderHtmlPrintable(o);
      w.document.write(html);
      w.document.close();
      // give time then focus and print
      setTimeout(()=>{ w.print(); }, 500);
    });
  });
}

/* ---------- UI actions ---------- */
cartBtn.addEventListener('click', showCart);
closeCart.addEventListener('click', ()=> cartModal.style.display='none');
document.getElementById('siteSearch').addEventListener('input', (e)=>{
  const q = (e.target.value||'').toLowerCase().trim();
  const filtered = PRODUCTS.filter(p=> p.name.toLowerCase().includes(q) || p.desc.toLowerCase().includes(q));
  renderProducts(filtered);
});

function showCart(){
  renderCart();
  loadUserDetails();
  txnMsg.textContent = ''; // clear any previous messages
  cartModal.style.display = 'flex';
}

document.getElementById('productGrid').addEventListener('click', (e)=>{
  if(e.target.classList.contains('addToCart')){
    const id = e.target.dataset.id;
    addToCart(id, 1);
  } else if (e.target.classList.contains('viewProductBtn')) {
    const id = e.target.dataset.id;
    if (id === 'g1') {
      showPopup(id);
    }
  } else if (e.target.classList.contains('prev-thumb')) {
    const id = e.target.dataset.id;
    const product = findProduct(id);
    if (!product || !product.img) return;
    const gallery = document.getElementById(`gallery-${id}`);
    const currentIdx = parseInt(gallery.dataset.index || '0');
    const newIdx = Math.max(0, currentIdx - 1);
    gallery.dataset.index = newIdx;
    updateThumbGallery(id, newIdx);
  } else if (e.target.classList.contains('next-thumb')) {
    const id = e.target.dataset.id;
    const product = findProduct(id);
    if (!product || !product.img) return;
    const gallery = document.getElementById(`gallery-${id}`);
    const currentIdx = parseInt(gallery.dataset.index || '0');
    const newIdx = Math.min(product.img.length - 1, currentIdx + 1);
    gallery.dataset.index = newIdx;
    updateThumbGallery(id, newIdx);
  }
});

cartListEl.addEventListener('click', (e)=>{
  if(e.target.classList.contains('incBtn')){
    const id = e.target.dataset.id;
    updateQty(id, (cart.find(c=>c.id===id).qty)+1);
  }else if(e.target.classList.contains('decBtn')){
    const id = e.target.dataset.id;
    const it = cart.find(c=>c.id===id);
    if(it.qty>1) updateQty(id, it.qty-1);
    else removeFromCart(id);
  }else if(e.target.classList.contains('removeBtn')){
    const id = e.target.dataset.id;
    removeFromCart(id);
  }
});

clearCartBtn.addEventListener('click', ()=> {
  if(confirm('Clear cart?')) clearCart();
});

/* proceed button scrolls to delivery */
proceedBtn.addEventListener('click', ()=>{
  // ensure there's at least one item
  if(cart.length===0){ alert('Cart is empty'); return; }
  // focus delivery form
  nameInput.focus();
});

/* init */
renderProducts();
renderCart();
showPromoExpiry();
loadUserDetails();
renderOrders();

/* ---------- small helpers ---------- */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function generatePlaceholderSVG(text){
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='300' height='200'><rect width='100%' height='100%' fill='%23e9f4ff'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%230b3558' font-size='18' font-family='Arial'>${escapeHtml(text)}</text></svg>`;
  return svg;
}
function viewProduct(id){
  const p = findProduct(id);
  alert(`${p.name}\n\n${p.desc}\n\nPrice: ${fmtINR(p.price)}\n\n${p.inStock? 'In stock' : 'Out of stock'}`);
}
function prettyOrderText(o){
  return `Order ${o.id}\nDate: ${new Date(o.date).toLocaleString()}\nName: ${o.name}\nPhone: ${o.phone}\nAddress: ${o.address}\n\nItems:\n${o.items.map(i=>`- ${i.name} x${i.qty} @ ₹${i.price}`).join('\n')}\n\nSubtotal: ₹${o.subtotal}\nDiscount: ₹${o.discount}\nTotal: ₹${o.total}\nTxn: ${o.txnId}`;
}
function renderOrderHtmlPrintable(o){
  const itemsHtml = o.items.map(i=>`<tr><td>${escapeHtml(i.name)}</td><td style="text-align:center">${i.qty}</td><td style="text-align:right">₹${i.price}</td></tr>`).join('');
  const html = `
  <html><head><title>Order ${o.id}</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif; padding:20px; color:#111}
    h1{color:#0b3558}
    table{width:100%; border-collapse:collapse; margin-top:10px}
    td,th{padding:8px; border-bottom:1px solid #eee}
    .muted{color:#666; font-size:13px}
  </style>
  </head><body>
    <h1>GlassKart — Order ${escapeHtml(o.id)}</h1>
    <div class="muted">Date: ${new Date(o.date).toLocaleString()}</div>
    <h3>Customer</h3>
    <div>${escapeHtml(o.name)} • ${escapeHtml(o.phone)}</div>
    <div>${escapeHtml(o.address)}</div>
    <h3>Items</h3>
    <table>
      <thead><tr><th>Product</th><th style="text-align:center">Qty</th><th style="text-align:right">Price</th></tr></thead>
      <tbody>${itemsHtml}</tbody>
    </table>
    <h3 style="text-align:right">Total: ₹${o.total}</h3>
    <div style="margin-top:20px" class="muted">Transaction ID: ${escapeHtml(o.txnId)}</div>
  </body></html>
  `;
  return html;
}

/* expose minimal API for console debugging */
window._gk = { addToCart, cart, PRODUCTS, clearCart };

/* Set promo suggestion expiry text */
(function setPromoText(){
  const opt = { year:'numeric', month:'short', day:'numeric' };
  const d = promoExpiryDate.toLocaleDateString(undefined,opt);
  document.getElementById('promoSuggest').querySelector('.muted')?.textContent;
  document.getElementById('promoExpiryText').textContent = d;
})();
</script>

</body>
</html>
</body>
</html>
